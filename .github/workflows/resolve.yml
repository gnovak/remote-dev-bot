name: Resolve Issue

# Reusable workflow â€” called by thin shims in target repos.
# See examples/agent.yml for the shim template.

on:
  workflow_call:
    secrets:
      ANTHROPIC_API_KEY:
        required: false
      OPENAI_API_KEY:
        required: false
      GEMINI_API_KEY:
        required: false
      PAT_TOKEN:
        required: false

jobs:
  resolve:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4

      - name: Checkout remote-dev-bot config
        uses: actions/checkout@v4
        with:
          repository: gnovak/remote-dev-bot
          token: ${{ secrets.PAT_TOKEN || github.token }}
          path: .remote-dev-bot
          sparse-checkout: remote-dev-bot.yaml
          sparse-checkout-cone-mode: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install PyYAML
        run: pip install PyYAML

      - name: Parse config and model alias
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          # Extract alias: "/agent-claude-large do X" -> "claude-large", "/agent" -> ""
          ALIAS=$(echo "$COMMENT" | grep -oP '^/agent-?\K[a-z0-9-]*' || echo "")

          python3 << PYEOF
          import yaml, sys, os

          def deep_merge(base, override):
              """Merge override into base, recursively for dicts."""
              result = base.copy()
              for key, value in override.items():
                  if key in result and isinstance(result[key], dict) and isinstance(value, dict):
                      result[key] = deep_merge(result[key], value)
                  else:
                      result[key] = value
              return result

          # Read base config from remote-dev-bot
          base_config = {}
          base_path = '.remote-dev-bot/remote-dev-bot.yaml'
          if os.path.exists(base_path):
              with open(base_path) as f:
                  base_config = yaml.safe_load(f) or {}

          # Read override config from target repo (if it exists)
          override_config = {}
          override_path = 'remote-dev-bot.yaml'
          if os.path.exists(override_path):
              with open(override_path) as f:
                  override_config = yaml.safe_load(f) or {}

          # Merge: target repo overrides remote-dev-bot defaults
          config = deep_merge(base_config, override_config)

          # Resolve model alias
          alias = '$ALIAS'
          if not alias:
              alias = config.get('default_model', 'claude-small')

          models = config.get('models', {})
          if alias not in models:
              print(f'ERROR: Unknown model alias: {alias}', file=sys.stderr)
              print(f'Available aliases: {list(models.keys())}', file=sys.stderr)
              sys.exit(1)

          model_id = models[alias]['id']

          # Read OpenHands settings
          oh = config.get('openhands', {})
          max_iter = oh.get('max_iterations', 50)
          oh_version = oh.get('version', '0.39.0')
          pr_type = oh.get('pr_type', 'ready')

          # Write outputs
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'model={model_id}\n')
              f.write(f'alias={alias}\n')
              f.write(f'max_iterations={max_iter}\n')
              f.write(f'oh_version={oh_version}\n')
              f.write(f'pr_type={pr_type}\n')

          # Log for visibility
          has_override = bool(override_config)
          print(f'Config: base=remote-dev-bot, override={"target repo" if has_override else "none"}')
          print(f'Model alias: {alias}')
          print(f'Model ID: {model_id}')
          print(f'PR type: {pr_type}')
          PYEOF

      - name: Determine API key
        id: apikey
        run: |
          MODEL="${{ steps.parse.outputs.model }}"
          if [[ "$MODEL" == anthropic/* ]]; then
            echo "key=${{ secrets.ANTHROPIC_API_KEY }}" >> "$GITHUB_OUTPUT"
          elif [[ "$MODEL" == openai/* ]]; then
            echo "key=${{ secrets.OPENAI_API_KEY }}" >> "$GITHUB_OUTPUT"
          elif [[ "$MODEL" == gemini/* ]]; then
            echo "key=${{ secrets.GEMINI_API_KEY }}" >> "$GITHUB_OUTPUT"
          else
            echo "::error::Unknown model provider for: $MODEL"
            exit 1
          fi

      - name: React to comment
        continue-on-error: true
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            --method POST --field content=rocket
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || github.token }}

      - name: Install OpenHands
        run: |
          pip install "openhands-ai==${{ steps.parse.outputs.oh_version }}" PyYAML

      - name: Clean up config checkout
        run: rm -rf .remote-dev-bot

      - name: Resolve issue
        env:
          LLM_API_KEY: ${{ steps.apikey.outputs.key }}
          LLM_MODEL: ${{ steps.parse.outputs.model }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || github.token }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
          GIT_USERNAME: ${{ github.repository_owner }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number || github.event.pull_request.number }}

          ISSUE_TYPE=${{ github.event.issue && 'issue' || 'pr' }}

          python -m openhands.resolver.resolve_issue \
            --selected-repo "${{ github.repository }}" \
            --issue-number "$ISSUE_NUMBER" \
            --issue-type "$ISSUE_TYPE" \
            --max-iterations ${{ steps.parse.outputs.max_iterations }} \
            --comment-id ${{ github.event.comment.id }}

      - name: Create pull request
        env:
          LLM_API_KEY: ${{ steps.apikey.outputs.key }}
          LLM_MODEL: ${{ steps.parse.outputs.model }}
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || github.token }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
          GIT_USERNAME: ${{ github.repository_owner }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number || github.event.pull_request.number }}
          TARGET_BRANCH=${{ github.event.pull_request.base.ref || 'main' }}

          python -m openhands.resolver.send_pull_request \
            --issue-number "$ISSUE_NUMBER" \
            --pr-type ${{ steps.parse.outputs.pr_type }} \
            --target-branch "$TARGET_BRANCH"

      - name: Upload output artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-output
          path: output.jsonl
          retention-days: 30
