name: Resolve Issue

# Reusable workflow â€” called by thin shims in target repos.
# See examples/agent.yml for the shim template.

on:
  workflow_call:
    secrets:
      ANTHROPIC_API_KEY:
        required: false
      OPENAI_API_KEY:
        required: false
      GEMINI_API_KEY:
        required: false
      PAT_TOKEN:
        required: false

jobs:
  resolve:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN || github.token }}

      - name: Checkout remote-dev-bot config
        uses: actions/checkout@v4
        with:
          repository: gnovak/remote-dev-bot
          token: ${{ secrets.PAT_TOKEN || github.token }}
          path: .remote-dev-bot
          sparse-checkout: lib

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install PyYAML
        run: pip install PyYAML

      - name: Parse config and model alias
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          # Extract alias: "/agent-claude-large do X" -> "claude-large", "/agent" -> ""
          ALIAS=$(echo "$COMMENT" | grep -oP '^/agent-?\K[a-z0-9-]*' || echo "")

          python3 .remote-dev-bot/lib/config.py "$ALIAS"

      - name: Determine API key
        id: apikey
        run: |
          MODEL="${{ steps.parse.outputs.model }}"
          if [[ "$MODEL" == anthropic/* ]]; then
            echo "key=${{ secrets.ANTHROPIC_API_KEY }}" >> "$GITHUB_OUTPUT"
          elif [[ "$MODEL" == openai/* ]]; then
            echo "key=${{ secrets.OPENAI_API_KEY }}" >> "$GITHUB_OUTPUT"
          elif [[ "$MODEL" == gemini/* ]]; then
            echo "key=${{ secrets.GEMINI_API_KEY }}" >> "$GITHUB_OUTPUT"
          else
            echo "::error::Unknown model provider for: $MODEL"
            exit 1
          fi

      - name: React to comment
        continue-on-error: true
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            --method POST --field content=rocket
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || github.token }}

      - name: Install OpenHands
        run: |
          pip install "openhands-ai==${{ steps.parse.outputs.oh_version }}" PyYAML

      - name: Clean up config checkout
        run: rm -rf .remote-dev-bot

      - name: Resolve issue
        env:
          LLM_API_KEY: ${{ steps.apikey.outputs.key }}
          LLM_MODEL: ${{ steps.parse.outputs.model }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || github.token }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
          GIT_USERNAME: ${{ github.repository_owner }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number || github.event.pull_request.number }}

          # Detect if this is a PR comment. Regular PR comments come through
          # issue_comment (PRs are issues), so github.event.issue exists but
          # github.event.issue.pull_request is only set for PRs. Review comments
          # come through pull_request_review_comment where github.event.issue
          # doesn't exist at all.
          ISSUE_TYPE=${{ (github.event.issue.pull_request || github.event.pull_request) && 'pr' || 'issue' }}

          python -m openhands.resolver.resolve_issue \
            --selected-repo "${{ github.repository }}" \
            --issue-number "$ISSUE_NUMBER" \
            --issue-type "$ISSUE_TYPE" \
            --max-iterations ${{ steps.parse.outputs.max_iterations }} \
            --comment-id ${{ github.event.comment.id }}

      - name: Create pull request
        env:
          LLM_API_KEY: ${{ steps.apikey.outputs.key }}
          LLM_MODEL: ${{ steps.parse.outputs.model }}
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || github.token }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
          GIT_USERNAME: ${{ github.repository_owner }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number || github.event.pull_request.number }}
          TARGET_BRANCH=${{ github.event.pull_request.base.ref || 'main' }}

          python -m openhands.resolver.send_pull_request \
            --issue-number "$ISSUE_NUMBER" \
            --pr-type ${{ steps.parse.outputs.pr_type }} \
            --target-branch "$TARGET_BRANCH"

      - name: Upload output artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-output
          path: output.jsonl
          retention-days: 30
