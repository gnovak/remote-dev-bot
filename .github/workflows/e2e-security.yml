name: E2E Security Tests
run-name: "E2E Security: ${{ inputs.test || 'all' }} on ${{ inputs.branch || 'main' }}"

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to test"
        required: false
        default: "main"
      test:
        description: "Test to run (all, exfiltration, gating)"
        required: false
        default: "all"

jobs:
  e2e-security:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.RDB_PAT_TOKEN || github.token }}

      - name: Run security E2E tests
        env:
          GH_TOKEN: ${{ secrets.RDB_PAT_TOKEN }}
          TESTER_PAT: ${{ secrets.TESTER_PAT_TOKEN }}
        run: |
          ARGS="--branch ${{ inputs.branch }}"
          if [[ -n "${{ inputs.test }}" && "${{ inputs.test }}" != "all" ]]; then
            ARGS="$ARGS --test ${{ inputs.test }}"
          fi
          ./tests/e2e-security.sh $ARGS
