name: E2E Security Tests
run-name: "E2E Security: ${{ inputs.test || 'all' }} on ${{ inputs.branch || 'main' }}"

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to test"
        required: false
        default: "main"
      test:
        description: "Test to run (all, sanity, exfiltration, gating)"
        required: false
        default: "all"

jobs:
  e2e-security:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        if: ${{ vars.RDB_APP_ID != '' }}
        with:
          app-id: ${{ vars.RDB_APP_ID }}
          private-key: ${{ secrets.RDB_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token || secrets.RDB_PAT_TOKEN || github.token }}

      - name: Run security E2E tests
        env:
          GH_TOKEN: ${{ secrets.RDB_TESTER_PAT_TOKEN || github.token }}
          UNAUTHORIZED_PAT: ${{ secrets.RDB_TESTER_UNAUTHORIZED_PAT_TOKEN }}
        run: |
          ARGS="--branch ${{ inputs.branch }}"
          if [[ -n "${{ inputs.test }}" && "${{ inputs.test }}" != "all" ]]; then
            ARGS="$ARGS --test ${{ inputs.test }}"
          fi
          ./tests/e2e-security.sh $ARGS
